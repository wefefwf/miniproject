<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springbootsmini.app.mapper.BoardMapper">



<!-- 상세 페이지 가기 -->

<!-- 게시글 한개만 가져오는 쿼리 -->
<select id="getBoardDetail" parameterType="map" resultType="Board">
    SELECT 
        board_id AS boardId,
        category_id AS categoryId,
        writer_id AS writerId,
        title,
        content,
        age,
        gender,
        birthday,
        region,
        recommend,
        thank,
        created_at AS createdAt
    FROM board b
    WHERE b.board_id = #{boardId}
      AND b.category_id = #{categoryId}
      <if test="hashtag != null and hashtag != ''">
        AND EXISTS (
            SELECT 1
            FROM board_hashtag bh
            JOIN hashtag h ON bh.hashtag_id = h.hashtag_id
            WHERE bh.board_id = b.board_id
              AND h.tag = #{hashtag}
        )
      </if>
</select>

<!-- 해당 게시물에 속하는 이미지 전체 가져오기(상세보기용) -->
<select id="getAllImagesByBoardId" parameterType="int" resultType="BoardImage">
    SELECT 
        bi.image_id AS imageId,
        bi.board_id AS boardId,
        bi.file_name AS fileName,
        bi.uploaded_at AS uploadedAt
    FROM board_image bi
    WHERE board_id = #{boardId}
    ORDER BY uploaded_at ASC
</select>


<!-- 여기까지 상세 페이지 -->
<!-- insertboard쿼리는 4개의 테이블에 값을 각각 넣어줘야함 -->
<!-- 한 board에 전부 넣고 값이없는건 null로 -->
 <!-- board Insert -->
 <insert id="addBoard" parameterType="Board" useGeneratedKeys="true"  keyProperty="boardId">
    INSERT INTO board
    (
        category_id,
        writer_id,
        pass,
        title,
        content,
        age,
        gender,
        birthday,
        region
    )
    VALUES
    (
        #{categoryId},
        #{writerId},
        #{pass},
        #{title},
        #{content},
        #{age},
        #{gender},
        #{birthday},
        #{region}
    )
</insert>
 
 <!-- board_Image Insert -->
 <insert id="addBoardImage" parameterType="BoardImage">
    INSERT INTO board_image
    (
        board_id,
        file_name
    )
    VALUES
    (
        #{boardId},
        #{fileName}
    )
</insert>

<!-- 게시글에 해당하는 해시태그 tag 가져오기 -->
 <select id="getHashtag" parameterType="int" resultType="BoardHashtag">
    SELECT h.hashtag_id, h.tag
	FROM board_hashtag bh
	JOIN hashtag h ON bh.hashtag_id = h.hashtag_id
	WHERE bh.board_id = ${boardId}
</select>

 <!-- hashtag Insert -->
 <!-- 해시태그는 있는지 확인하고 없으면 넣어야됨 -->
 <select id="getHashtagId" parameterType="String" resultType="int">
    SELECT hashtag_id
    FROM hashtag
    WHERE tag = #{hashtag}
</select>
 
 <insert id="addHashtag" parameterType="String" useGeneratedKeys="true" keyProperty="hashtagId">
    INSERT INTO hashtag (tag)
    VALUES (#{hashtag})
</insert>
 
 <!-- board_hashtag Insert -->
 <insert id="addBoardHashtag" parameterType="map">
    INSERT INTO board_hashtag
    (
        board_id,
        hashtag_id
    )
    VALUES
    (
        #{boardId},
        #{hashtagId}
    )
</insert>
 
 <!-- 여기까지 insert -->
 
<!-- 해당 게시물에 속하는 이미지들 가져오기 (썸네일용)-->
<select id="getThumbnailByBoardId" parameterType="map" resultType="BoardImage">
    SELECT
        bi.image_id AS imageId,
        bi.board_id AS boardId,
        bi.file_name AS fileName,
        bi.uploaded_at AS uploadedAt
    FROM board_image bi
    JOIN board b ON bi.board_id = b.board_id
    <where>
        b.category_id = #{category}
        AND b.board_id = #{boardId}
        <if test="hashtag != null and hashtag != ''">
            AND EXISTS (
                SELECT 1
                FROM board_hashtag bh
                JOIN hashtag h ON bh.hashtag_id = h.hashtag_id
                WHERE bh.board_id = b.board_id
                  AND h.tag = #{hashtag} )
        </if>
    </where>
    ORDER BY bi.uploaded_at DESC
    LIMIT 1
</select>


<!-- 해당 쿼리의 전체 게시글 갯수를 가져오는 쿼리 / 해시태그도 추가되어 있음 -->
<select id="getBoardCount">
	SELECT COUNT(board_id)
	FROM board b
	WHERE b.category_id = #{category}
	<if test="hashtag != null and hashtag != ''">
	  AND EXISTS (
	    SELECT 1
	    FROM board_hashtag bh
	    JOIN hashtag h ON bh.hashtag_id = h.hashtag_id
	    WHERE bh.board_id = b.board_id
	    AND h.tag  = #{hashtag}
	  )
	</if>
</select>

<!-- 카테고리에 해당하는 게시글 가져오는 쿼리 / 해시태그도 추가되어 있음  -->
<select id="boardList" parameterType="map" resultType="Board">
	SELECT 
        board_id AS boardId,
        category_id AS categoryId,
        writer_id AS writerId,
        title,
        content,
        age,
        gender,
        birthday,
        region,
        recommend,
        thank,
        created_at AS createdAt
	FROM board b
	WHERE b.category_id = #{category}
	
	<if test="hashtag != null and hashtag != ''">
	  AND EXISTS (
	    SELECT 1
	    FROM board_hashtag bh
	    JOIN hashtag h ON bh.hashtag_id = h.hashtag_id
	    WHERE bh.board_id = b.board_id
	    AND h.tag  = #{hashtag}
	  )
	</if>
		ORDER BY board_id DESC
		LIMIT #{startRow}, #{num};
</select>
</mapper>
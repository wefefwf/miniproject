<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layouts/main_layout}">
<head>
    <style>
        .cart-img { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .qty-btn:hover { background: #eee; }
        .total-summary { background-color: #f8f9fa; border-radius: 15px; padding: 25px; margin-top: 30px; }
        .summary-item { font-size: 1.1rem; }
    </style>
</head>
<body>
    <div layout:fragment="content" class="container mt-5">
        <h2 class="fw-bold mb-4"><i class="bi bi-cart3"></i> 장바구니</h2>
        <form id="cartForm" th:action="@{/order/form}" method="post">
            <table class="table align-middle text-center shadow-sm bg-white rounded">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60px;"><input type="checkbox" id="selectAll" class="form-check-input" checked></th>
                        <th>상품 정보</th>
                        <th>수량</th>
                        <th>상품 금액</th>
                        <th>합계</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${cartList}">
                        <td><input type="checkbox" name="cartIds" th:value="${item.cartNo}" class="cart-check form-check-input" checked></td>
                        <td class="text-start">
                            <div class="d-flex align-items-center">
                                <img th:src="${item.image_url}" class="cart-img me-3">
                                <span th:text="${item.product_name}" class="fw-bold">상품명</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex justify-content-center align-items-center">
                                <button type="button" class="qty-btn" th:onclick="|changeQty('${item.cartNo}', '${item.count}', -1)|">-</button>
                                <span class="mx-3 fw-bold" th:text="${item.count} + '개'">1개</span>
                                <button type="button" class="qty-btn" th:onclick="|changeQty('${item.cartNo}', '${item.count}', 1)|">+</button>
                            </div>
                        </td>
                        <td th:text="'₩' + ${#numbers.formatInteger(item.price, 0, 'COMMA')}"></td>
                        <td class="fw-bold text-success item-total" th:text="'₩' + ${#numbers.formatInteger(item.price * item.count, 0, 'COMMA')}"></td>
                        <td>
                            <button type="button" class="btn btn-link text-danger text-decoration-none fw-bold" th:onclick="|deleteCartItem('${item.cartNo}')|">삭제</button>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(cartList)}">
                        <td colspan="6" class="py-5 text-muted">장바구니에 담긴 상품이 없습니다.</td>
                    </tr>
                </tbody>
            </table>

<!--총금액과 배송비 -->
           <div class="total-summary shadow-sm border-0 mb-4" style="background-color: #f8f9fa; border-radius: 15px; padding: 25px; margin-top: 30px;">
    <div class="row text-center align-items-center">
        <div class="col">
            <div class="text-muted small mb-1">총 상품금액</div>
            <div class="fw-bold fs-5 text-dark" id="totalProductPrice">₩0</div>
        </div>
        
        <div class="col-auto">
            <div class="rounded-circle d-flex align-items-center justify-content-center" 
                 style="width: 32px; height: 32px; border: 2px solid #dee2e6; background: #fff;">
                <i class="bi bi-plus-lg fw-bold text-secondary" style="font-size: 1rem; display: flex; align-items: center;"></i>
            </div>
        </div>

        <div class="col">
            <div class="text-muted small mb-1">총 배송비</div>
            <div class="fw-bold fs-5 text-dark" id="shippingFee">₩3,000</div>
        </div>

        <div class="col-auto">
            <div class="rounded-circle d-flex align-items-center justify-content-center" 
                 style="width: 32px; height: 32px; border: 2px solid #dee2e6; background: #fff;">
                <span class="fw-bold text-secondary" style="font-size: 1.2rem; line-height: 1; margin-top: -2px;">=</span>
            </div>
        </div>

        <div class="col">
            <div class="text-muted small mb-1 text-primary fw-bold">결제예정금액</div>
            <div class="fw-bold fs-4 text-primary" id="finalPrice">₩3,000</div>
        </div>
    </div>
</div>

            <div class="text-center mt-5 mb-5 d-flex justify-content-center gap-3">
                <a th:href="@{/productList}" class="btn btn-outline-secondary btn-lg fw-bold px-5 py-3 shadow-sm text-decoration-none">
                    <i class="bi bi-arrow-left"></i> 쇼핑 계속하기
                </a>
                <button type="submit" class="btn btn-warning btn-lg fw-bold px-5 py-3 shadow-sm">
                    선택 상품 주문하기
                </button>
            </div>
        </form>

        <script th:inline="javascript">
            // 1. 실시간 합계 계산 함수
            function updateTotalPrice() {
                let total = 0;
                document.querySelectorAll('.cart-check:checked').forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const priceText = row.querySelector('.item-total').innerText;
                    const price = parseInt(priceText.replace(/[^0-9]/g, ''));
                    total += price;
                });

                // 상품이 있을 때만 배송비 3,000원 적용
                const shipping = total > 0 ? 3000 : 0;
                
                document.getElementById('totalProductPrice').innerText = '₩' + total.toLocaleString();
                document.getElementById('shippingFee').innerText = '₩' + shipping.toLocaleString();
                document.getElementById('finalPrice').innerText = '₩' + (total + shipping).toLocaleString();
            }

            // 2. 초기화 및 이벤트 리스너 등록
            document.addEventListener('DOMContentLoaded', function() {
                updateTotalPrice(); // 페이지 로드 시 최초 계산

                // 체크박스 변경 시마다 계산 업데이트
                document.querySelectorAll('.form-check-input').forEach(input => {
                    input.addEventListener('change', updateTotalPrice);
                });

                // 전체 선택 기능
                const selectAll = document.getElementById('selectAll');
                if (selectAll) {
                    selectAll.addEventListener('change', function() {
                        document.querySelectorAll('.cart-check').forEach(cb => {
                            cb.checked = this.checked;
                        });
                        updateTotalPrice();
                    });
                }
            });

            // 3. 삭제 함수
            window.deleteCartItem = function(cartNo) {
                if (!confirm("장바구니에서 삭제하시겠습니까?")) return;
                fetch('/cart/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ 'cartNo': cartNo })
                })
                .then(res => res.text())
                .then(data => {
                    if (data === "success") location.reload(); 
                    else alert("삭제 처리에 실패했습니다.");
                });
            };

            // 4. 수량 변경 함수
            window.changeQty = function(cartNo, currentQty, change) {
                const newQty = parseInt(currentQty) + change;
                if (newQty < 1) return;
                fetch('/cart/updateQty', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ 'cartNo': cartNo, 'count': newQty })
                })
                .then(res => res.text())
                .then(data => {
                    if (data === "success") location.reload();
                    else alert("수량 변경 실패");
                });
            };
        </script>
    </div>
</body>
</html>
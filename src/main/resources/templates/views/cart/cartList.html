<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layouts/main_layout}">
<head>
    <style>
        .cart-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .qty-btn:hover { background: #eee; }
        .total-summary { background-color: #f8f9fa; border-radius: 15px; padding: 25px; margin-top: 30px; }
        .summary-item { font-size: 1.1rem; }

        /* --- 좌우로 '탁 탁' 튀는 쉐이크 애니메이션 --- */
        /* 비어있을 때 흔들리는 쇼핑백 전용 클래스 */
	.shopping-bag-anim {
	    width: 280px; 
	    height: auto;
	    margin-bottom: 25px;
	    display: inline-block;
	    /* 4초 주기로 무한 반복: 0.6초간 흔들리고 나머지는 쉼 */
	    animation: surprise-shake 4s infinite;
	}
	
	@keyframes surprise-shake {
	    /* 0% ~ 15% 구간 (약 0.6초): 탁탁탁! 움직이는 구간 */
	    0%   { transform: translateX(0); }
	    3%   { transform: translateX(-10px) rotate(-3deg); }
	    6%   { transform: translateX(10px) rotate(3deg); }
	    9%   { transform: translateX(-10px) rotate(-3deg); }
	    12%  { transform: translateX(10px) rotate(3deg); }
	    15%  { transform: translateX(0); }
	
	    /* 15% ~ 100% 구간 (약 3.4초): 가만히 숨 고르는 구간 */
	    100% { transform: translateX(0); }
	}

        /* 버튼 스타일 */
        .go-shopping-btn {
            border: 2px solid #003366;
            border-radius: 30px;
            padding: 12px 50px;
            color: #003366 !important;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: 0.3s;
            background-color: transparent;
        }
        .go-shopping-btn:hover {
            background-color: #003366;
            color: #ffffff !important;
        }
        /* --------------------------- */
    </style>
</head>
<body>
    <div layout:fragment="content" class="container mt-5">
        <h2 class="fw-bold mb-4"><i class="bi bi-cart3"></i> 장바구니</h2>
        <form id="cartForm" th:action="@{/order/form}" method="post">
            <table class="table align-middle text-center shadow-sm bg-white rounded">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60px;"><input type="checkbox" id="selectAll" class="form-check-input" checked></th>
                        <th>상품 정보</th>
                        <th>수량</th>
                        <th>상품 금액</th>
                        <th>합계</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${cartList}">
                        <td><input type="checkbox" name="cartIds" th:value="${item.cartNo}" class="cart-check form-check-input" checked></td>
                        <td class="text-start">
                            <div class="d-flex align-items-center">
                                <img th:src="${item.image_url}" class="cart-img me-3">
                                <span th:text="${item.product_name}" class="fw-bold">상품명</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex justify-content-center align-items-center">
                                <button type="button" class="qty-btn" th:onclick="|changeQty('${item.cartNo}', '${item.count}', -1)|">-</button>
                                <span class="mx-3 fw-bold" th:text="${item.count} + '개'">1개</span>
                                <button type="button" class="qty-btn" th:onclick="|changeQty('${item.cartNo}', '${item.count}', 1)|">+</button>
                            </div>
                        </td>
                        <td th:text="'₩' + ${#numbers.formatInteger(item.price, 0, 'COMMA')}"></td>
                        <td class="fw-bold text-success item-total" th:text="'₩' + ${#numbers.formatInteger(item.price * item.count, 0, 'COMMA')}"></td>
                        <td>
                            <button type="button" class="btn btn-link text-danger text-decoration-none fw-bold" th:onclick="|deleteCartItem('${item.cartNo}')|">삭제</button>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(cartList)}">
                        <td colspan="6" class="py-5">
                            <div style="text-align: center; padding: 50px 0;">
                                <img th:src="@{/upload/bag.png}" class="shopping-bag-anim" alt="Empty Cart">
                                <p class="text-muted fs-5 mb-4">장바구니에 담긴 상품이 없습니다.</p>
                                <a th:href="@{/productList}" class="go-shopping-btn">
                                    상품 담으러 가기
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div th:if="${!#lists.isEmpty(cartList)}" class="total-summary shadow-sm border-0 mb-4">
                <div class="row text-center align-items-center">
                    <div class="col">
                        <div class="text-muted small mb-1">총 상품금액</div>
                        <div class="fw-bold fs-5 text-dark" id="totalProductPrice">₩0</div>
                    </div>
                    <div class="col-auto">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 32px; height: 32px; border: 2px solid #dee2e6; background: #fff;">
                            <i class="bi bi-plus-lg fw-bold text-secondary"></i>
                        </div>
                    </div>
                    <div class="col">
                        <div class="text-muted small mb-1">총 배송비</div>
                        <div class="fw-bold fs-5 text-dark" id="shippingFee">₩3,000</div>
                    </div>
                    <div class="col-auto">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 32px; height: 32px; border: 2px solid #dee2e6; background: #fff;">
                            <span class="fw-bold text-secondary" style="font-size: 1.2rem;">=</span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="text-muted small mb-1 text-primary fw-bold">결제예정금액</div>
                        <div class="fw-bold fs-4 text-primary" id="finalPrice">₩3,000</div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5 mb-5 d-flex justify-content-center gap-3">
                <a th:href="@{/productList}" class="btn btn-outline-secondary btn-lg fw-bold px-5 py-3 shadow-sm text-decoration-none">
                    <i class="bi bi-arrow-left"></i> 쇼핑 계속하기
                </a>
                <button th:if="${!#lists.isEmpty(cartList)}" type="submit" class="btn btn-warning btn-lg fw-bold px-5 py-3 shadow-sm">
                    선택 상품 주문하기
                </button>
            </div>
        </form>

        <script th:inline="javascript">
            function updateTotalPrice() {
                let total = 0;
                document.querySelectorAll('.cart-check:checked').forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const itemTotal = row.querySelector('.item-total');
                    if (itemTotal) {
                        const price = parseInt(itemTotal.innerText.replace(/[^0-9]/g, ''));
                        total += price;
                    }
                });

                const shipping = total > 0 ? 3000 : 0;
                
                const prodPriceElem = document.getElementById('totalProductPrice');
                const shipFeeElem = document.getElementById('shippingFee');
                const finalPriceElem = document.getElementById('finalPrice');

                if (prodPriceElem) prodPriceElem.innerText = '₩' + total.toLocaleString();
                if (shipFeeElem) shipFeeElem.innerText = '₩' + shipping.toLocaleString();
                if (finalPriceElem) finalPriceElem.innerText = '₩' + (total + shipping).toLocaleString();
            }

            document.addEventListener('DOMContentLoaded', function() {
                updateTotalPrice();
                document.querySelectorAll('.form-check-input').forEach(input => {
                    input.addEventListener('change', updateTotalPrice);
                });
                const selectAll = document.getElementById('selectAll');
                if (selectAll) {
                    selectAll.addEventListener('change', function() {
                        document.querySelectorAll('.cart-check').forEach(cb => {
                            cb.checked = this.checked;
                        });
                        updateTotalPrice();
                    });
                }
            });

            window.deleteCartItem = function(cartNo) {
                if (!confirm("장바구니에서 삭제하시겠습니까?")) return;
                fetch('/cart/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ 'cartNo': cartNo })
                })
                .then(res => res.text())
                .then(data => {
                    if (data === "success") location.reload(); 
                    else alert("삭제 처리에 실패했습니다.");
                });
            };

            window.changeQty = function(cartNo, currentQty, change) {
                const newQty = parseInt(currentQty) + change;
                if (newQty < 1) return;
                fetch('/cart/updateQty', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ 'cartNo': cartNo, 'count': newQty })
                })
                .then(res => res.text())
                .then(data => {
                    if (data === "success") location.reload();
                    else alert("수량 변경 실패");
                });
            };
        </script>
    </div>
</body>
</html>
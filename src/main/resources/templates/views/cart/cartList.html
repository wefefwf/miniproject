<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layouts/main_layout}">
<head>
    <style>
        .cart-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .qty-btn:hover { background: #eee; }
        .total-summary { background-color: #f8f9fa; border-radius: 15px; padding: 25px; margin-top: 30px; }
        .summary-item { font-size: 1.1rem; }

        /* --- 장바구니 애니메이션 (유지) --- */
        .shopping-bag-anim {
            width: 280px; 
            height: auto;
            margin-bottom: 25px;
            display: inline-block;
            animation: surprise-shake 4s infinite;
        }
        @keyframes surprise-shake {
            0%   { transform: translateX(0); }
            3%   { transform: translateX(-10px) rotate(-3deg); }
            6%   { transform: translateX(10px) rotate(3deg); }
            9%   { transform: translateX(-10px) rotate(-3deg); }
            12%  { transform: translateX(10px) rotate(3deg); }
            15%  { transform: translateX(0); }
            100% { transform: translateX(0); }
        }

        .go-shopping-btn {
            border: 2px solid #003366; border-radius: 30px; padding: 12px 50px;
            color: #003366 !important; font-weight: bold; text-decoration: none;
            display: inline-block; transition: 0.3s; background-color: transparent;
        }
        .go-shopping-btn:hover { background-color: #003366; color: #ffffff !important; }
        
        /* --- [수정] 배너 화살표 완전 대칭 정렬 --- */
        .carousel-control-prev,
        .carousel-control-next {
            width: 40px !important;   /* 클릭 영역을 좁게 고정하여 배너 안 침범 방지 */
            height: 40px;
            top: 50% !important;
            transform: translateY(-50%);
            opacity: 1 !important;    /* 선명하게 보이도록 */
            background: none;
        }

        /* 배너 이미지 바깥으로 똑같이 밀어내기 (숫자를 동일하게 맞춤) */
        .carousel-control-prev {
            left: -50px !important;  /* 왼쪽으로 50px */
        }

        .carousel-control-next {
            right: -50px !important; /* 오른쪽으로 50px */
        }

        /* 아이콘 모양 보정 */
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            width: 30px;
            height: 30px;
            filter: none !important; /* 색상 왜곡 방지 */
        }
    </style>
</head>
<body>
    <div layout:fragment="content" class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold m-0"><i class="bi bi-cart3"></i> 장바구니</h2>
            <button th:if="${!#lists.isEmpty(cartList)}" type="button" class="btn btn-outline-danger fw-bold shadow-sm" onclick="deleteSelectedItems()">
                <i class="bi bi-trash"></i> 선택 삭제
            </button>
        </div>

        <form id="cartForm" th:action="@{/order/form}" method="post">
            <table class="table align-middle text-center shadow-sm bg-white rounded">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60px;"><input type="checkbox" id="selectAll" class="form-check-input" checked></th>
                        <th>상품 정보</th>
                        <th>수량</th>
                        <th>상품 금액</th>
                        <th>합계</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${cartList}">
                        <td><input type="checkbox" name="cartIds" th:value="${item.cartNo}" class="cart-check form-check-input" checked></td>
                        <td class="text-start">
                            <div class="d-flex align-items-center">
                                <img th:src="${item.image_url}" class="cart-img me-3">
                                <span th:text="${item.product_name}" class="fw-bold">상품명</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex justify-content-center align-items-center">
                                <button type="button" class="qty-btn" th:onclick="|changeQty('${item.cartNo}', '${item.count}', -1)|">-</button>
                                <span class="mx-3 fw-bold" th:text="${item.count} + '개'">1개</span>
                                <button type="button" class="qty-btn" th:onclick="|changeQty('${item.cartNo}', '${item.count}', 1)|">+</button>
                            </div>
                        </td>
                        <td th:text="'₩' + ${#numbers.formatInteger(item.price, 0, 'COMMA')}"></td>
                        <td class="fw-bold text-success item-total" th:text="'₩' + ${#numbers.formatInteger(item.price * item.count, 0, 'COMMA')}"></td>
                        <td>
                            <button type="button" class="btn btn-link text-danger text-decoration-none fw-bold" th:onclick="|deleteCartItem('${item.cartNo}')|">삭제</button>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(cartList)}">
                        <td colspan="6" class="py-5">
                            <div style="text-align: center; padding: 50px 0;">
                                <img th:src="@{/upload/bag.png}" class="shopping-bag-anim" alt="Empty Cart">
                                <p class="text-muted fs-5 mb-4">장바구니에 담긴 상품이 없습니다.</p>
                                <a th:href="@{/productList}" class="go-shopping-btn">
                                    상품 담으러 가기
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div th:if="${!#lists.isEmpty(cartList)}" class="total-summary shadow-sm border-0 mb-4">
                <div class="row text-center align-items-center">
                    <div class="col">
                        <div class="text-muted small mb-1">총 상품금액</div>
                        <div class="fw-bold fs-5 text-dark" id="totalProductPrice">₩0</div>
                    </div>
                    <div class="col-auto">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 32px; height: 32px; border: 2px solid #dee2e6; background: #fff;">
                            <i class="bi bi-plus-lg fw-bold text-secondary"></i>
                        </div>
                    </div>
                    <div class="col">
                        <div class="text-muted small mb-1">총 배송비</div>
                        <div class="fw-bold fs-5 text-dark" id="shippingFee">₩3,000</div>
                    </div>
                    <div class="col-auto">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 32px; height: 32px; border: 2px solid #dee2e6; background: #fff;">
                            <span class="fw-bold text-secondary" style="font-size: 1.2rem;">=</span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="text-muted small mb-1 text-primary fw-bold">결제예정금액</div>
                        <div class="fw-bold fs-4 text-primary" id="finalPrice">₩3,000</div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5 mb-5 d-flex justify-content-center gap-3">
                <a th:href="@{/productList}" class="btn btn-outline-secondary btn-lg fw-bold px-5 py-3 shadow-sm text-decoration-none">
                    <i class="bi bi-arrow-left"></i> 쇼핑 계속하기
                </a>
                <button th:if="${!#lists.isEmpty(cartList)}" type="submit" class="btn btn-warning btn-lg fw-bold px-5 py-3 shadow-sm">
                    선택 상품 주문하기
                </button>
            </div>
        </form>

        <script th:inline="javascript">
            // 기존 가격 업데이트 및 체크박스 로직 (유지)
            function updateTotalPrice() {
                let total = 0;
                document.querySelectorAll('.cart-check:checked').forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const itemTotal = row.querySelector('.item-total');
                    if (itemTotal) {
                        const price = parseInt(itemTotal.innerText.replace(/[^0-9]/g, ''));
                        total += price;
                    }
                });
                const shipping = total > 0 ? 3000 : 0;
                document.getElementById('totalProductPrice').innerText = '₩' + total.toLocaleString();
                document.getElementById('shippingFee').innerText = '₩' + shipping.toLocaleString();
                document.getElementById('finalPrice').innerText = '₩' + (total + shipping).toLocaleString();
            }

            document.addEventListener('DOMContentLoaded', function() {
                updateTotalPrice();
                document.querySelectorAll('.form-check-input').forEach(input => {
                    input.addEventListener('change', updateTotalPrice);
                });
                const selectAll = document.getElementById('selectAll');
                if (selectAll) {
                    selectAll.addEventListener('change', function() {
                        document.querySelectorAll('.cart-check').forEach(cb => {
                            cb.checked = this.checked;
                        });
                        updateTotalPrice();
                    });
                }
            });

            // 개별 삭제 (유지)
            window.deleteCartItem = function(cartNo) {
                if (!confirm("장바구니에서 삭제하시겠습니까?")) return;
                fetch('/cart/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ 'cartNo': cartNo })
                })
                .then(res => res.text())
                .then(data => {
                    if (data === "success") location.reload(); 
                    else alert("삭제 처리에 실패했습니다.");
                });
            };

            // [추가] 선택 삭제 기능
            window.deleteSelectedItems = function() {
                const checkedBoxes = document.querySelectorAll('.cart-check:checked');
                if (checkedBoxes.length === 0) {
                    alert("삭제할 상품을 선택해주세요.");
                    return;
                }
                if (!confirm("선택한 " + checkedBoxes.length + "개의 상품을 삭제하시겠습니까?")) return;

                const cartNos = Array.from(checkedBoxes).map(cb => cb.value);
                
                // 순차적으로 삭제 요청을 보낸 후 모두 완료되면 새로고침
                Promise.all(cartNos.map(cartNo => 
                    fetch('/cart/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ 'cartNo': cartNo })
                    })
                )).then(() => location.reload());
            };

            // 수량 변경 (유지)
            window.changeQty = function(cartNo, currentQty, change) {
                const newQty = parseInt(currentQty) + change;
                if (newQty < 1) return;
                fetch('/cart/updateQty', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ 'cartNo': cartNo, 'count': newQty })
                })
                .then(res => res.text())
                .then(data => {
                    if (data === "success") location.reload();
                    else alert("수량 변경 실패");
                });
            };
        </script>
    </div>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main_layout}">
<head>
    <meta charset="UTF-8">
    <title>ReeFlo - 주문서 작성</title>
    <link rel="stylesheet" th:href="@{/css/order.css}">
    
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
    <div layout:fragment="content" class="order-container">
        <h2 style="font-weight: 800; margin-bottom: 30px;">주문서 작성</h2>

        <section class="info-section">
            <div class="section-header">
                <h3 class="section-subtitle">주문 상품 확인</h3>
                <div class="header-buttons">
                    <a href="/cart/list" class="btn-sub">장바구니 이동</a>
                    <a href="/productList" class="btn-main">상품 더 추가하기</a>
                </div>
            </div>
            <table class="order-table">
                <thead>
                    <tr>
                        <th class="col-name">상품정보</th>
                        <th class="col-count">수량</th>
                        <th class="col-price">소계</th>
                        <th class="col-action">삭제</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${orderItems}" th:id="'row-' + ${item.cartNo}">
                        <td class="col-name">
                            <div class="product-item">
                                <img th:src="${item.image_url}" alt="상품이미지" class="product-img">
                                <span th:text="${item.product_name}">상품명</span>
                            </div>
                        </td>
                        <td class="col-count" th:text="|${item.count}개|">1개</td>
                        <td class="col-price" th:text="|₩${#numbers.formatInteger(item.price * item.count, 0, 'COMMA')}|">0</td>
                        <td class="col-action">
                            <button type="button" class="btn-del-item" th:onclick="removeRow([[${item.cartNo}]])">×</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="info-section">
            <h3 class="section-subtitle" style="margin-bottom: 20px;">배송 정보 입력</h3>
            <div class="info-group">
                <div class="info-label">받는 분</div>
                <input type="text" id="buyer_name" class="info-input" th:value="${user.name}">
            </div>
            <div class="info-group">
                <div class="info-label">우편번호</div>
                <input type="text" id="postcode" class="info-input" readonly placeholder="우편번호">
                <button type="button" class="btn-addr" onclick="execDaumPostcode()">주소 검색</button>
            </div>
            <div class="info-group">
                <div class="info-label">기본 주소</div>
                <input type="text" id="address" class="info-input" readonly placeholder="기본 주소">
            </div>
            <div class="info-group">
                <div class="info-label">상세 주소</div>
                <input type="text" id="detailAddress" class="info-input" placeholder="상세 주소를 입력해주세요">
            </div>
            <div class="info-group">
                <div class="info-label">배송 요청사항</div>
                <select id="request_select" class="info-input" onchange="handleRequestChange()">
                    <option value="">-- 배송 요청사항 선택 --</option>
                    <option value="문 앞에 놓아주세요">문 앞에 놓아주세요</option>
                    <option value="배송 전 미리 연락 바랍니다">배송 전 미리 연락 바랍니다</option>
                    <option value="부재 시 경비실에 맡겨주세요">부재 시 경비실에 맡겨주세요</option>
                    <option value="direct">직접 입력</option>
                </select>
            </div>
            <div id="direct_input_div" class="info-group" style="display: none;">
                <div class="info-label"></div> 
                <input type="text" id="order_memo" class="info-input" placeholder="요청사항을 직접 입력해주세요">
            </div>
        </section>

        <div class="total-box">
            <div style="margin-bottom: 8px; color: #666;">상품 합계: <span th:text="|₩${#numbers.formatInteger(totalPrice, 0, 'COMMA')}|">0</span></div>
            <div style="margin-bottom: 12px; color: #666;">배송비: <span>₩3,000</span></div>
            <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">
            <div style="font-weight: bold;">
                <span style="color: #333; margin-right: 15px;">최종 결제 예정 금액</span>
                <span class="total-price" th:text="|₩${#numbers.formatInteger(totalPrice + 3000, 0, 'COMMA')}|">₩0</span>
            </div>
        </div>

        <button type="button" class="btn-pay" id="orderBtn" 
                th:data-amount="${totalPrice + 3000}" 
                onclick="requestPay()">주문 완료하기</button>

        <script th:src="@{/js/order.js}"></script>
    </div>
</body>
</html>
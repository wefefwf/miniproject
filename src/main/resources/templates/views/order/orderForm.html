<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main_layout}">
<head>
    <meta charset="UTF-8">
    <title>ReeFlo - ì£¼ë¬¸ì„œ ì‘ì„±</title>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        :root { --main-green: #4CAF50; --dark-green: #2E7D32; --bg-light: #f1f8e9; }
        .order-container { max-width: 900px; margin: 40px auto; padding: 0 20px; font-family: 'Pretendard', sans-serif; }
        
        .info-section { margin-bottom: 30px; background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-left: 4px solid var(--main-green); padding-left: 10px; }
        .section-subtitle { font-size: 1.1rem; font-weight: 700; color: var(--dark-green); margin: 0; }

        /* í…Œì´ë¸” ì •ë ¬ */
        .order-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .order-table th { background-color: var(--bg-light); padding: 12px; border-bottom: 2px solid var(--main-green); font-size: 0.9rem; }
        .order-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .col-name { width: 45%; text-align: left; }
        .col-count { width: 15%; text-align: center; }
        .col-price { width: 30%; text-align: right; font-weight: 700; padding-right: 40px !important; } 
        .col-action { width: 10%; text-align: center; }

        /* ì…ë ¥ í¼ ê³µí†µ ì •ë ¬ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„) */
        .info-group { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; width: 100%; }
        .info-label { width: 120px; font-weight: 600; color: #555; font-size: 0.9rem; flex-shrink: 0; }
        .info-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; height: 40px; box-sizing: border-box; }
        
        .btn-addr { height: 40px; padding: 0 15px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: bold; white-space: nowrap; }

        .total-box { background-color: var(--bg-light); padding: 25px; border-radius: 12px; text-align: right; margin-bottom: 30px; border: 1px solid #e0e0e0; }
        .total-price { font-size: 1.5rem; font-weight: 800; color: #dc3545; }
        .btn-pay { width: 100%; padding: 18px; background-color: var(--main-green); color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>
    <div layout:fragment="content" class="order-container">
        <h2 style="font-weight: 800; margin-bottom: 30px;">ì£¼ë¬¸ì„œ ì‘ì„±</h2>

        <section class="info-section">
            <div class="section-header">
                <h3 class="section-subtitle">ğŸ“¦ ì£¼ë¬¸ ìƒí’ˆ í™•ì¸</h3>
                <a href="/product/list" style="font-size: 0.85rem; color: var(--main-green); text-decoration: none; border: 1px solid var(--main-green); padding: 5px 15px; border-radius: 20px;">ìƒí’ˆ ë” ì¶”ê°€í•˜ê¸°</a>
            </div>
            <table class="order-table">
                <thead>
                    <tr>
                        <th class="col-name">ìƒí’ˆì •ë³´</th>
                        <th class="col-count">ìˆ˜ëŸ‰</th>
                        <th class="col-price">ì†Œê³„</th>
                        <th class="col-action">ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${orderItems}" th:id="'row-' + ${item.cartNo}">
                        <td class="col-name" th:text="${item.product_name}">ìƒí’ˆëª…</td>
                        <td class="col-count" th:text="|${item.count}ê°œ|">1ê°œ</td>
                        <td class="col-price" th:text="|â‚©${#numbers.formatInteger(item.price * item.count, 0, 'COMMA')}|">0</td>
                        <td class="col-action"><button type="button" class="btn-del-item" th:onclick="removeRow([[${item.cartNo}]])">Ã—</button></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="info-section">
            <h3 class="section-subtitle" style="margin-bottom: 20px;">ğŸ“ ë°°ì†¡ ì •ë³´ ì…ë ¥</h3>
            
            <div class="info-group">
                <div class="info-label">ë°›ëŠ” ë¶„</div>
                <input type="text" id="buyer_name" class="info-input" th:value="${user.name}">
            </div>
            
            <div class="info-group">
                <div class="info-label">ìš°í¸ë²ˆí˜¸</div>
                <input type="text" id="postcode" class="info-input" readonly>
                <button type="button" class="btn-addr" onclick="execDaumPostcode()">ì£¼ì†Œ ê²€ìƒ‰</button>
            </div>
            
            <div class="info-group">
                <div class="info-label">ê¸°ë³¸ ì£¼ì†Œ</div>
                <input type="text" id="address" class="info-input" readonly>
            </div>
            
            <div class="info-group">
                <div class="info-label">ìƒì„¸ ì£¼ì†Œ</div>
                <input type="text" id="detailAddress" class="info-input" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
            </div>

            <div class="info-group">
                <div class="info-label">ë°°ì†¡ ìš”ì²­ì‚¬í•­</div>
                <select id="request_select" class="info-input" onchange="handleRequestChange()">
                    <option value="">-- ë°°ì†¡ ìš”ì²­ì‚¬í•­ ì„ íƒ --</option>
                    <option value="ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”">ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
                    <option value="ë°°ì†¡ ì „ ë¯¸ë¦¬ ì—°ë½ ë°”ëë‹ˆë‹¤">ë°°ì†¡ ì „ ë¯¸ë¦¬ ì—°ë½ ë°”ëë‹ˆë‹¤</option>
                    <option value="ë¶€ì¬ ì‹œ ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”">ë¶€ì¬ ì‹œ ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
                    <option value="direct">ì§ì ‘ ì…ë ¥</option>
                </select>
            </div>
            
            <div id="direct_input_div" class="info-group" style="display: none;">
                <div class="info-label"></div> <input type="text" id="order_memo" class="info-input" placeholder="ìš”ì²­ì‚¬í•­ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”">
            </div>
        </section>

        <div class="total-box">
            <span style="color: #666; margin-right: 15px;">ì´ ê²°ì œ ì˜ˆì • ê¸ˆì•¡</span>
            <span class="total-price" th:text="|â‚©${#numbers.formatInteger(totalPrice, 0, 'COMMA')}|">0</span>
        </div>

        <button type="button" class="btn-pay" onclick="requestPay()">ì£¼ë¬¸ ì™„ë£Œí•˜ê¸°</button>

        <script th:inline="javascript">
            function handleRequestChange() {
                const select = document.getElementById('request_select');
                const directDiv = document.getElementById('direct_input_div');
                const memoInput = document.getElementById('order_memo');

                if (select.value === 'direct') {
                    directDiv.style.display = 'flex';
                    memoInput.value = "";
                    memoInput.focus();
                } else {
                    directDiv.style.display = 'none';
                    memoInput.value = select.value;
                }
            }

            function execDaumPostcode() {
                new daum.Postcode({
                    oncomplete: function(data) {
                        document.getElementById('postcode').value = data.zonecode;
                        document.getElementById("address").value = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                        document.getElementById("detailAddress").focus();
                    }
                }).open();
            }

            function requestPay() {
                const rows = document.querySelectorAll('tbody tr');
                const cartIds = [];
                rows.forEach(r => cartIds.push(r.id.replace('row-', '')));
                const postcode = document.getElementById('postcode').value;
                const detail = document.getElementById('detailAddress').value.trim();

                if(cartIds.length === 0) { alert("ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤."); return; }
                if(!postcode || !detail) { alert("ë°°ì†¡ì§€ ì •ë³´ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

                if(confirm("ì£¼ë¬¸ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    const merchant_uid = "order_" + new Date().getTime();
                    let url = "/order/success?merchant_uid=" + merchant_uid;
                    cartIds.forEach(id => url += "&cartIds=" + id);
                    location.href = url;
                }
            }
        </script>
    </div>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main_layout}"> 
<head>
    <meta charset="UTF-8">
    <title>ReeFlo - ì‡¼í•‘ëª°</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>
    <style>
    :root { --main-green: #4CAF50; --dark-green: #2E7D32; --bg-light: #f1f8e9; --border-gray: #eee; --text-dark: #333; }
    .search-wrapper { margin: 30px 0; display: flex; justify-content: center; padding: 0 20px; }
    .search-inner { width: 100%; max-width: 550px; position: relative; border: 2px solid var(--main-green); border-radius: 35px; overflow: hidden; }
    .search-inner input { width: 100%; padding: 14px 25px; border: none; outline: none; font-size: 1rem; }
    .search-btn { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; }

    /* --- [ë°°ë„ˆ ì„¹ì…˜ ìˆ˜ì •] í™”ì‚´í‘œ ê³µê°„ í™•ë³´ ë° ì˜ë¦¼ ë°©ì§€ --- */
    .banner-section { 
        max-width: 1200px; 
        margin: 0 auto 30px; 
        padding: 0 70px; /* í™”ì‚´í‘œê°€ ìœ„ì¹˜í•  ì¶©ë¶„í•œ ê³µê°„ */
        position: relative; 
        overflow: visible !important; 
    }

    /* --- [ë°°ë„ˆ ë°•ìŠ¤ ìˆ˜ì •] ë†’ì´ ê³ ì •ì„ í•´ì œí•˜ì—¬ ì´ë¯¸ì§€ ì „ì²´ ë…¸ì¶œ --- */
    .banner-box { 
        position: relative; 
        width: 100%; 
        height: auto; /* ê³ ì • ë†’ì´ 200px ì œê±° */
        border-radius: 25px; 
        overflow: hidden; 
        outline: none; 
    }
    .banner-box img { 
        width: 100%; 
        height: auto; /* ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆ */
        display: block;
        object-fit: contain; /* ì´ë¯¸ì§€ ì „ì²´ë¥¼ ë‹¤ ë³´ì—¬ì¤Œ */
    }

    .category-nav { text-align: center; margin: 40px 0; }
    .category-tab { display: inline-block; padding: 12px 30px; margin: 0 8px; border: 2px solid var(--main-green); border-radius: 35px; text-decoration: none; color: var(--main-green); font-weight: 700; transition: 0.3s; }
    .category-tab:hover, .category-tab.active { background-color: var(--main-green); color: #fff; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .section-wrapper { margin-bottom: 70px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 25px; border-bottom: 2px solid var(--main-green); }
    .section-title { font-size: 1.5rem; font-weight: 700; }
    .section-title span { color: var(--main-green); margin-right: 10px; }
    .product-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; }
    .product-card { border: 1px solid var(--border-gray); border-radius: 18px; overflow: hidden; transition: all 0.3s ease; text-decoration: none; color: inherit; background: #fff; display: block; position: relative; }
    .product-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0,0,0,0.08); }
    
    .img-box { background-color: var(--bg-light); height: 250px; width: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center; }
    .img-box img { width: 100%; height: 100%; object-fit: cover; object-position: center; }
    
    .info-box { padding: 20px; }
    .brand-text { font-size: 0.85rem; color: #999; margin-bottom: 8px; }
    .product-name { font-size: 1rem; font-weight: 600; height: 2.8em; line-height: 1.4; overflow: hidden; margin-bottom: 12px; }
    .price-row { display: flex; justify-content: space-between; align-items: center; }
    .price-text { font-size: 1.25rem; font-weight: 800; color: var(--dark-green); }
    .btn-green { background-color: var(--main-green); color: white; padding: 8px 16px; border-radius: 25px; border: none; cursor: pointer; font-weight: 700; }

    /* --- [Slick í™”ì‚´í‘œ ìˆ˜ì •] ë°–ìœ¼ë¡œ ë§ì´ ë°€ê¸° --- */
    .main-slider { overflow: visible !important; }
    .main-slider .slick-prev, .main-slider .slick-next {
        width: 40px; height: 40px; top: 50% !important; transform: translateY(-50%); z-index: 100;
    }
    .main-slider .slick-prev { left: -55px !important; } /* ë°–ìœ¼ë¡œ ì´ë™ */
    .main-slider .slick-next { right: -55px !important; } /* ë°–ìœ¼ë¡œ ì´ë™ */

    .slick-prev:before, .slick-next:before {
        color: var(--main-green) !important; font-size: 40px !important; opacity: 1 !important;
    }

    .admin-add-btn { display: inline-block; padding: 10px 25px; background-color: var(--dark-green); color: white; text-decoration: none; border-radius: 30px; font-weight: bold; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; transition: 0.3s; }
    .admin-add-btn:hover { background-color: var(--text-dark); color: white; }
    .admin-mini-bar { margin-bottom: 15px; display: flex; gap: 8px; }
    .admin-btn-common { flex: 1; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border-radius: 6px; text-decoration: none; cursor: pointer; box-sizing: border-box; border: 1px solid transparent; transition: 0.2s; }
    .admin-link { background: #f4f4f4; color: #666; border: 1px solid #ddd; }
    .admin-link:hover { background: #eee; }
    .admin-del-btn { background: #fff5f5; color: #ff4d4d; border: 1px solid #ffdada; width: 100%; }
    .admin-del-btn:hover { background: #ffebeb; }

    .floating-cart-wrap { position: fixed; bottom: 40px; right: 40px; z-index: 999; text-align: center; }
    .floating-cart-btn { width: 80px; height: 80px; background: white; border: 3px solid var(--main-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15); text-decoration: none; position: relative; transition: transform 0.3s ease; }
    .floating-cart-btn:hover { transform: scale(1.1); }
    .floating-cart-btn img { width: 60px; height: auto; border-radius: 50%; }
    .cart-count-badge { position: absolute; top: -5px; right: -5px; background-color: #ff4d4d; color: white; font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 20px; border: 2px solid white; min-width: 20px; text-align: center; }
    .floating-label { display: block; margin-top: 8px; font-size: 12px; font-weight: bold; color: var(--dark-green); background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 10px; }
</style>
</head>
<body>

    <div layout:fragment="content">
        
        <div class="search-wrapper">
    <form th:action="@{/productList}" method="get" class="search-inner">
        <input type="hidden" name="category_id" th:value="${param.category_id != null ? param.category_id[0] : cList[0].category_id}">
        
        <input type="text" name="keyword" th:value="${param.keyword}" placeholder="ì°¾ìœ¼ì‹œëŠ” ìƒí’ˆì„ ì…ë ¥í•˜ì„¸ìš”...">
        <button type="submit" class="search-btn">ğŸ”</button>
    </form>
</div>

        <div class="banner-section">
            <div class="main-slider">
                <div class="banner-box"><img th:src="@{/upload/main/banner1.jpg}" alt="ë°°ë„ˆ1"></div>
                <div class="banner-box"><img th:src="@{/upload/main/banner2.jpg}" alt="ë°°ë„ˆ2"></div>
            </div>
        </div>

        <nav class="category-nav">
            <th:block th:each="cat, catStat : ${cList}">
                <a th:href="@{/productList(category_id=${cat.category_id})}" 
                   class="category-tab" 
                   th:classappend="${(param.category_id != null and #strings.equals(param.category_id[0], #strings.toString(cat.category_id))) or (param.category_id == null and catStat.first) ? 'active' : ''}"
                   th:text="${cat.category_name}">ì¹´í…Œê³ ë¦¬ëª…</a>
            </th:block>
        </nav>

        <div class="container">
        <!-- ë§¤ë‹ˆì €ë§Œ ë²„íŠ¼ì´ ë³´ì´ë„ë¡ (ìƒˆìƒí’ˆ ë“±ë¡) -->
           <div style="text-align: right;" th:if="${session.user != null and session.user.manager eq 1}">
			    <a th:href="@{/productWrite}" class="admin-add-btn">+ ìƒˆ ìƒí’ˆ ë“±ë¡í•˜ê¸°</a>
			</div>

            <section class="section-wrapper">
                <div class="section-header">
                    <div class="section-title"><span>ğŸŒ¿</span>ì‚¬ë£Œ/ê°„ì‹</div>
                </div>
                
                <div class="product-grid">
                    <div class="product-card" th:each="p : ${pList}">
                        <div class="img-box" 
                             th:onclick="|location.href='@{/productDetail(product_id=${p.product_id}, category_id=${param.category_id})}'|" 
                             style="cursor:pointer;">
                            <img th:src="@{${p.image_url}}" alt="ìƒí’ˆì´ë¯¸ì§€">
                        </div>
                        <div class="info-box">
                            <div class="brand-text">ReeFlo Pick</div>
                            <div class="product-name" th:text="${p.product_name}">ìƒí’ˆëª…</div>
                            
                            <!-- ìˆ˜ì •ê³¼ ì‚­ì œë„ ë§ˆì°¬ê°€ì§€ë¡œ -->
                              <div class="admin-mini-bar" th:if="${session.user != null and (session.user.manager == 1 or session.user.manager == '1')}">
							    <a th:href="@{/productUpdate(product_id=${p.product_id})}" class="admin-btn-common admin-link">ìˆ˜ì •</a>
							    <form th:action="@{/productDelete}" method="post" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" style="flex: 1; display: flex;">
							        <input type="hidden" name="product_id" th:value="${p.product_id}">
							        <button type="submit" class="admin-btn-common admin-del-btn">ì‚­ì œ</button>
							    </form>
							</div>

                            <div class="price-row">
                                <div class="price-text" th:text="|â‚©${#numbers.formatInteger(p.price, 0, 'COMMA')}|">0</div>
                                <button type="button" class="btn-green add-cart-btn" 
                                        th:data-id="${p.product_id}" 
                                        th:data-name="${p.product_name}">ë‹´ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="floating-cart-wrap">
            <a th:href="@{/cart/list}" class="floating-cart-btn">
                <img th:src="@{/upload/bag_item.jpg}" alt="Cart">
                <span class="cart-count-badge" id="cartBadgeCount"
                      th:style="${session.cartCount == null or session.cartCount == 0} ? 'display:none' : 'display:block'"
                      th:text="${session.cartCount != null ? session.cartCount : 0}">0</span>
            </a>
            <span class="floating-label">ì¥ë°”êµ¬ë‹ˆ ì´ë™</span>
        </div>

        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
        <script th:inline="javascript">
            $(document).ready(function(){
                $('.main-slider').slick({
                    autoplay: true,
                    autoplaySpeed: 2500,
                    dots: true,
                    fade: true,
                    arrows: true
                });

                $('.add-cart-btn').on('click', function(e){
                    e.stopPropagation(); 

                    const pId = $(this).data('id');
                    const pName = $(this).data('name');
                    const $badge = $('#cartBadgeCount'); 

                    $.ajax({
                        url: /*[[@{/cart/add}]]*/ '/cart/add',
                        type: 'POST',
                        data: { product_id: pId, count: 1 },
                        success: function(res) {
                            if(res === "success") {
                                alert(pName + " ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤! ");
                                let currentCount = parseInt($badge.text()) || 0;
                                let newCount = currentCount + 1;
                                $badge.text(newCount).show(); 
                                
                            } else if(res === "login_required") {
                                const currentFullUrl = window.location.pathname + window.location.search;
                                if(confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?")) {
                                    const loginUrl = /*[[@{/loginForm}]]*/ '/loginForm';
                                    location.href = loginUrl + "?redirectUrl=" + encodeURIComponent(currentFullUrl);
                                }
                            }
                        },
                        error: function() {
                            alert("í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                });
            });
        </script>
    </div>
</body>
</html>
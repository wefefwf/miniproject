<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main_layout}">
<head>
    <meta charset="UTF-8">
    <title th:text="${product.product_name} + ' - ReeFlo'">상품 상세</title>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --main-green: #4CAF50; --dark-green: #2E7D32; --bg-light: #f1f8e9; --text-dark: #333; }
        
        .detail-wrapper { max-width: 1200px; margin: 50px auto; padding: 0 20px; }
        .product-main { display: flex; gap: 40px; align-items: flex-start; }
        
        /* 슬라이더 영역 */
        .slider-container { width: 500px; background: var(--bg-light); border-radius: 20px; overflow: hidden; padding: 20px; }
        .slider img { width: 100%; height: 450px; object-fit: contain; border-radius: 15px; }
        
        /* 상품 정보 영역 */
        .info-container { flex: 1; padding: 10px 0; }
        .brand-text { color: var(--main-green); font-weight: 700; font-size: 1.1rem; margin-bottom: 10px; }
        .product-name { font-size: 2.2rem; font-weight: 700; margin-bottom: 15px; }
        .price-box { font-size: 1.8rem; font-weight: 800; color: var(--dark-green); border-bottom: 2px solid #f5f5f5; padding-bottom: 20px; margin-bottom: 30px; }
        
        .desc-box { line-height: 1.8; color: #666; margin-bottom: 40px; min-height: 100px; }
        
        /* 버튼 영역 */
        .btn-group-custom { display: flex; gap: 15px; }
        .btn-cart { flex: 1; padding: 18px; border: 2px solid var(--main-green); color: var(--main-green); background: #fff; border-radius: 12px; font-weight: 700; font-size: 1.1rem; transition: 0.3s; }
        .btn-buy { flex: 2; padding: 18px; border: none; background: var(--main-green); color: #fff; border-radius: 12px; font-weight: 700; font-size: 1.1rem; transition: 0.3s; cursor: pointer;}
        .btn-buy:hover { background: var(--dark-green); }
        
        .back-link { display: inline-block; margin-top: 30px; color: #999; text-decoration: none; font-size: 0.9rem; }
        .back-link:hover { text-decoration: underline; }

        .icon-circle-green { 
            width: 85px; height: 85px; background: #fff; border: 2px solid #e8f5e9; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            margin: 0 auto; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.1); 
        }
        .green-info-box { background-color: #f1f8e9; border: 1px solid #c8e6c9; }
        .table-light-green { background-color: #f9fbf9 !important; color: var(--dark-green) !important; font-weight: 600; }
        .custom-table th, .custom-table td { vertical-align: middle; font-size: 0.95rem; padding: 12px; }

        .slick-dots { bottom: 10px; }
        .slick-prev:before, .slick-next:before { color: var(--main-green) !important; }
    </style>
</head>
<body>

    <th:block layout:fragment="content">
        <div class="detail-wrapper">
            <div class="product-main">
                <div class="slider-container">
                    <div class="slider">
                        <img th:src="${product.image_url}" alt="main_img">
                        <img th:src="@{/upload/food/food1.jpg}" alt="food1">
                        <img th:src="@{/upload/food/food2.jpg}" alt="food2">
                    </div>
                </div>

                <div class="info-container">
                    <div class="brand-text">ReeFlo Pick</div>
                    <h1 class="product-name" th:text="${product.product_name}">상품 이름</h1>
                    <div class="price-box" th:text="|₩${#numbers.formatInteger(product.price, 0, 'COMMA')}|">0원</div>
                    
                    <div class="desc-box">
                        <p th:text="${product.description}">여기에 상품 상세 설명이 들어갑니다.</p>
                    </div>

                    <div class="btn-group-custom">
                        <button id="addCartBtn" class="btn-cart" th:value="${product.product_id}">장바구니</button>
                        <button type="button" class="btn-buy" id="buyNowBtn" th:data-id="${product.product_id}">바로 구매하기</button>
                    </div>
                    
                    <a href="/productList" class="back-link">← 목록으로 돌아가기</a>
                </div>
            </div>

            <hr class="my-5" style="border-color: #eee;">

            <div class="product-description-wrapper">
                <div class="check-point-section mb-5">
                    <h3 class="text-center fw-bold mb-4">ReeFlo <span style="color: var(--main-green);">Check</span> Point</h3>
                    
                    <div class="d-flex justify-content-around text-center mb-5">
                        <div class="check-item">
                            <div class="icon-circle-green mb-2">
                                <img src="https://img.icons8.com/fluency/48/star--v1.png" alt="평점"/>
                            </div>
                            <p class="fw-bold mb-1" style="color: var(--dark-green);" 
                               th:text="${product.rating}">0.0</p>
                            <small class="text-muted">평점체크</small>
                        </div>
                        <div class="check-item">
                            <div class="icon-circle-green mb-2">
                               <img src="https://img.icons8.com/color/48/guarantee--v1.png" alt="안심"/>
                            </div>
                            <p class="fw-bold mb-1" style="color: var(--dark-green);" 
                               th:text="${product.recall_status}">없음</p>
                            <small class="text-muted">리콜 경험</small>
                        </div>
                        <div class="check-item">
                            <div class="icon-circle-green mb-2">
                                <img src="https://img.icons8.com/fluency/48/leaf.png" alt="성분"/>
                            </div>
                            <p class="fw-bold mb-1" style="color: var(--dark-green);" 
                               th:text="${product.ingredient_check}">통과</p>
                            <small class="text-muted">성분 기준</small>
                        </div>
                    </div>
                </div>

                <div class="product-spec-section mt-5">
                    <div class="d-flex align-items-center mb-3">
                        <div style="width: 4px; height: 18px; background-color: var(--main-green); margin-right: 10px;"></div>
                        <h4 class="fw-bold mb-0">상품 고시 정보</h4>
                    </div>
                    <table class="table table-bordered custom-table">
                        <tbody>
                            <tr>
                                <th class="table-light-green w-25">품명 및 모델명</th>
                                <td th:text="${product.product_name}">상품명</td>
                            </tr>
                            <tr>
                                <th class="table-light-green">원료구성</th>
                                <td th:text="${product.ingredients != null ? product.ingredients : '패키지 별도 표기'}">원료 정보</td>
                            </tr>
                            <tr>
                                <th class="table-light-green">성분구성</th>
                                <td th:text="${product.nutrition != null ? product.nutrition : '상세 설명 참조'}">성분 정보</td>
                            </tr>
                            <tr>
                                <th class="table-light-green">제조국 / 제조사</th>
                                <td th:text="${product.origin_manufacturer}">대한민국 / ReeFlo 파트너사</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold">Cart</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="d-flex align-items-center p-3 mb-4" style="background-color: #f1f8e9; border-radius: 15px;">
                            <img th:src="${product.image_url}" width="70" height="70" class="rounded-3 me-3" style="object-fit: cover;">
                            <div class="text-start">
                                <p class="mb-1 fw-bold" th:text="${product.product_name}">상품명</p>
                                <p class="mb-0 text-success fw-bold" th:text="|₩${#numbers.formatInteger(product.price, 0, 'COMMA')}|">가격</p>
                            </div>
                        </div>
                        <p class="fw-bold mb-0">장바구니에 상품을 성공적으로 담았습니다!</p>
                    </div>
                    <div class="modal-footer border-0 p-3">
                        <a href="/cart/list" class="btn fw-bold w-100 mb-2" style="background-color: #FFD700; border-radius: 12px;">장바구니 보기</a>
                        <button type="button" class="btn fw-bold w-100" data-bs-dismiss="modal" style="background-color: #f0f0f0; border-radius: 12px;">계속 쇼핑</button>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
        <script th:inline="javascript">
            $(document).ready(function(){
                // 슬라이더 설정
                $('.slider').slick({
                    dots: true,
                    infinite: true,
                    speed: 500,
                    fade: true,
                    cssEase: 'linear'
                });

                // 장바구니 클릭 이벤트
                $('#addCartBtn').on('click', function() {
                    const p_id = $(this).val();
                    $.ajax({
                        url: '/cart/add',
                        type: 'POST',
                        data: { product_id: p_id, count: 1 },
                        success: function(res) {
                            if(res === "success") {
                                const myModal = new bootstrap.Modal(document.getElementById('cartModal'));
                                myModal.show();
                            } else if(res === "login_required") {
                                alert("로그인이 필요한 서비스입니다.");
                                location.href = "/loginForm";
                            }
                        }
                    });
                });

                // [수정 완료] 바로 구매하기 클릭 이벤트
                $('#buyNowBtn').on('click', function() {
                    // th:data-id 속성에 저장된 값을 가져옵니다.
                    const p_id = $(this).data('id'); 
                    const count = 1; 

                    if(!p_id) {
                        alert("상품 정보를 불러올 수 없습니다.");
                        return;
                    }

                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/order/direct';

                    const pIdInput = document.createElement('input');
                    pIdInput.type = 'hidden';
                    pIdInput.name = 'product_id';
                    pIdInput.value = p_id;

                    const countInput = document.createElement('input');
                    countInput.type = 'hidden';
                    countInput.name = 'count';
                    countInput.value = count;

                    form.appendChild(pIdInput);
                    form.appendChild(countInput);
                    document.body.appendChild(form);
                    
                    form.submit();
                });
            });
        </script>
    </th:block>
</body>
</html>